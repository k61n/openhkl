variables:
  DEBIAN_FRONTEND: noninteractive

image: ubuntu:22.04

before_script:
  - apt-get update
  - apt-get install -y
      build-essential
      build-essential
      cmake
      libblosc-dev
      libeigen3-dev
      libfftw3-dev
      libgl-dev
      libgsl-dev
      libhdf5-dev
      libopencv-dev
      libpython3-dev
      libqhull-dev
      libtiff-dev
      libyaml-cpp-dev
      python3
      python3-numpy
      qt5-qmake
      qtbase5-dev
      qtbase5-dev-tools
      qtchooser
      swig
      python3-pip
      doxygen
      graphviz

stages:
  - build
  - deploy:doc

build:ubuntu:
  stage: build
  script:
  - mkdir build
  - cd build
  - |
    if test $CI_PIPELINE_SOURCE == "nightly"
    then
        cmake .. -D OHKL_FULL_WORKFLOW_TEST=ON
    else
        cmake ..
    fi
  - make -j8
  - |
    if test $CI_PIPELINE_SOURCE == "nightly"
    then
        ctest -j8 --output-on-failure -L "nightly"
    else
        ctest -j8 --output-on-failure -E "nightly"
    fi
  # artifacts:
  #   paths:
  #   - src/libmandel.so
  #   expire_in: 1 day

pages:
  stage: deploy:doc
  script:
    - python3 -m pip install -U pip
    - python3 -m pip install
        sphinx
        sphinxcontrib-bibtex
        sphinx-press-theme
        breathe
    - mkdir build
    - cd build
    - cmake ..
    - make docs
    - mv doc/sphinx/html ../public/
    - mv doc/sphinx/_static/* ../public/_static/
  artifacts:
    paths:
      - public
  only:
    - main
