stages:
  - build

deb_test_clang:
  tags: &unix
  - Linux
  image: debian:testing
  before_script: &debian_clang
    - apt-get -y update
    - apt-get -y upgrade
    - apt-get -y install cmake swig git
    - apt-get -y install qtbase5-dev libblosc-dev libgsl-dev libfftw3-dev libeigen3-dev
    - apt-get -y install libhdf5-dev libyaml-cpp-dev libtiff-dev libboost-dev
    - apt-get -y install python3 python3-distutils libpython3-dev
    - apt-get -y install python3-numpy python3-unittest2 python3-random2
    - apt-get -y install clang
    - git clone https://jugit.fz-juelich.de/mlz/libQCR.git
    - git clone https://jugit.fz-juelich.de/mlz/xsection.git
  stage: build
  script: &scr
    - pwd && ls
    - cd libQCR && mkdir build && cd build
    - cmake .. && make && ctest && make install
    - cd ../.. && pwd && ls
    - cd xsection && mkdir build && cd build
    - cmake .. && make -j3 && ctest && make install
    - cd ../.. && pwd && ls
    - mkdir build
    - cd build
    - cmake ..
    - make -j8
    - ctest -j8 --output-on-failure

deb_testing_gcc:
  tags: *unix
  image: debian:testing
  before_script: &debian_gcc
    - apt-get -y update
    - apt-get -y upgrade
    - apt-get -y install cmake swig git
    - apt-get -y install qtbase5-dev libblosc-dev libgsl-dev libfftw3-dev libeigen3-dev
    - apt-get -y install libhdf5-dev libyaml-cpp-dev libtiff-dev libboost-dev
    - apt-get -y install python3 python3-distutils libpython3-dev
    - apt-get -y install python3-numpy python3-unittest2 python3-random2
    - apt-get -y install g++
    - git clone https://jugit.fz-juelich.de/mlz/libQCR.git
    - git clone https://jugit.fz-juelich.de/mlz/xsection.git
  stage: build
#   script: *scr
#
#  NOTE [JWu21jun19]:
#  Tests are suspended since we know that several of them are broken under gcc
#
  script:
    - pwd && ls
    - cd libQCR && mkdir build && cd build
    - cmake .. && make && ctest && make install
    - cd ../.. && pwd && ls
    - cd xsection && mkdir build && cd build
    - cmake .. && make -j3 && ctest && make install
    - cd ../.. && pwd && ls
    - mkdir build
    - cd build
    - cmake ..
    - make -j8

# suse_clang:
#
#   NOTE [JWu21jun19]:
#   We suspend Suse support because of bug in libhdf5:
#     ldd on that lib shows an entry 'z' instead of the full path to the zlib.
#   Should we ever need to support Suse, then of course we could easily work around
#     this bug by explicitly calling FindZLIB, and adding ZLIB_LIBRARIES to the core link list.
#
#   tags: *unix
#   image: opensuse/tumbleweed
#   # rolling release with infinite life time
#   before_script:
#     - zypper -n patch || echo "do it again"
#     - zypper -n patch
#     - zypper -n ref
#     - zypper -n up
#     - zypper -n dup
#     - zypper -n in git cmake clang perl pkgconf libqt5-qtbase-devel blosc-devel gsl-devel fftw3-devel eigen3-devel hdf5-devel yaml-cpp-devel libtiff-devel-32bit boost-devel python3 python3-numpy python3-unittest2 python3-random2 python3-distutils-extra python3-devel swig
#     - git clone https://jugit.fz-juelich.de/mlz/libQCR.git
#     - git clone https://jugit.fz-juelich.de/mlz/xsection.git
#   stage: build
#   script: *scr

# centos7_clang:
#
#   NOTE [JWu21jun19]:
#   We suspend Centos because the compiler is too old (clang 3.4.2),
#     and is not able to compile the CMake simple test program.
#
#   tags: *unix
#   image: centos:centos7
#   before_script:
#     - yum -y update
#     - yum -y install epel-release
#     - yum repolist
#     - yum -y install make git cmake3 clang pkgconf libqt5-qtbase-devel blosc-devel gsl-devel fftw3-devel eigen3-devel hdf5-devel yaml-cpp-devel libtiff-devel boost-devel python3 python3-numpy python3-unittest2 python3-random2 python36-distutils-extra python3-devel swig
#     - cmake3 --version
#     - ctest3 --version
#     - cpack3 --version
#     - ln -s /usr/bin/cmake3 /usr/bin/cmake
#     - ln -s /usr/bin/ctest3 /usr/bin/ctest
#     - ln -s /usr/bin/cpack3 /usr/bin/cpack
#     - git clone https://jugit.fz-juelich.de/mlz/libQCR.git
#     - git clone https://jugit.fz-juelich.de/mlz/xsection.git
#   stage: build
#   script: *scr

# windows:
#   tags:
#   - Windows
#   stage: build
#   script:
#     - New-Item -ItemType "directory" -Confirm:$false -Force:$true -Name "build"
#     - cd build
#     - cmd.exe "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars64.bat"
#     - cmake -G "Visual Studio 15 2017" -A x64 -T host=x64 -DLIB_MAN=OFF -DLIB_INSTALL=OFF -B. ..
#     - cmake --build . --config Release
#     - Get-Location
#     - dir
#     - dir Release
#     - ctest -C Release --output-on-failure
