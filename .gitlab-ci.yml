variables:
  DEBIAN_FRONTEND: noninteractive

stages:
  - build
  - test
  - deploy:doc

build:rocky9:
  stage: build
  image: iffregistry.fz-juelich.de/neutron-simlab/openhkl/rocky9-ohkl-env
  script:
    - |
      if test $CI_PIPELINE_SOURCE == "nightly"
      then
          cmake -B build -D OHKL_FULL_WORKFLOW_TEST=ON -D CMAKE_BUILD_TYPE=Release
      else
          cmake -B build -D CMAKE_BUILD_TYPE=Release
      fi
    - cmake --build build
  artifacts:
    paths:
      - build
    expire_in: 1 day

test:rocky9:
  stage: test
  image: iffregistry.fz-juelich.de/neutron-simlab/openhkl/rocky9-ohkl-env
  timeout: 3 hours
  script:
    - cd build
    - |
      if test $CI_PIPELINE_SOURCE == "nightly"
      then
          ctest --output-on-failure -L "nightly"
      else
          ctest -j8 --output-on-failure -E "nightly"
      fi

pages:
  stage: deploy:doc
  image: iffregistry.fz-juelich.de/neutron-simlab/openhkl/rocky9-ohkl-env
  script:
    - cd build
    - cmake ..
    - make docs
    - mv doc/sphinx/html ../public/
    - mv doc/sphinx/_static/* ../public/_static/
  artifacts:
    paths:
      - public
  only:
    - main
