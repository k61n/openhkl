variables:
  DEBIAN_FRONTEND: noninteractive

image: iffregistry.fz-juelich.de/neutron-simlab/openhkl/ubuntu2204-env

stages:
  - build
  - deploy:doc

build:ubuntu:
  stage: build
  script:
  - mkdir build
  - cd build
  - |
    if test $CI_PIPELINE_SOURCE == "nightly"
    then
        cmake .. -D OHKL_FULL_WORKFLOW_TEST=ON
    else
        cmake ..
    fi
  - make -j8
  - |
    if test $CI_PIPELINE_SOURCE == "nightly"
    then
        ctest --output-on-failure -L "nightly"
    else
        ctest -j8 --output-on-failure -E "nightly"
    fi
  artifacts:
    paths:
    - build
    expire_in: 1 day

pages:
  stage: deploy:doc
  script:
    - python3 -m pip install -U pip
    - python3 -m pip install
        sphinx
        sphinxcontrib-bibtex
        sphinx-press-theme
        breathe
    - cd build
    - cmake ..
    - make docs
    - mv doc/sphinx/html ../public/
    - mv doc/sphinx/_static/* ../public/_static/
  artifacts:
    paths:
      - public
  only:
    - main
